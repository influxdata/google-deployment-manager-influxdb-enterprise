{
    "min_packer_version": "0.12.0",
    "variables": {
        "project_id": "{{env `GOOGLE_CLOUD_PROJECT`}}",
        "service_account_json": "{{env `GOOGLE_CREDENTIALS`}}",
        "region": "us-central1",
        "zone": "us-central1-f",
        "listing_type": "byol",
        "influxdb_version": "1.7.10",
        "telegraf_version": "1.13.4"
    },
    "builders": [
        {
            "name": "gcp",
            "type": "googlecompute",
            "project_id": "{{user `project_id`}}",
            "machine_type": "n1-standard-1",
            "source_image_family": "ubuntu-1804-lts",
            "region": "{{user `region`}}",
            "zone": "{{user `zone`}}",
            "image_description": "InfluxData's InfluxDB Enterprise meta node, v{{ user `influxdb_version` }}, based on Ubuntu 18.04 LTS, built on {{ isotime \"2006-01-02\" }}.",
            "image_name": "influxdb-enterprise-{{user `listing_type`}}-meta-{{ user `influxdb_version` | clean_image_name}}-ubuntu-{{ isotime \"2006-01-02\" | clean_image_name }}",
            "image_family": "influxdb-enterprise",
            "image_licenses": [
              "https://www.googleapis.com/compute/v1/projects/influxdata-public/global/licenses/influxdb-ent-vm-meta"
            ],
            "disk_size": "10",
            "disk_type": "pd-standard",
            "account_file": "{{ user `service_account_json`}}",
            "ssh_username": "ubuntu"
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "pause_before": "30s",
            "inline": [
                "sudo DEBIAN_FRONTEND=noninteractive apt-get update -y",
                "sudo apt-get install -y jq google-cloud-sdk"
            ]
        },
        {
            "type": "file",
            "source": "../licenses/licenses.tar.gz",
            "destination": "/tmp/licenses.tar.gz"
        },
        {
            "type": "shell",
            "inline": [
                "sudo mkdir /usr/local/share/licenses",
                "sudo tar xvzf /tmp/licenses.tar.gz --directory /usr/local/share/licenses/",
                "rm /tmp/licenses.tar.gz"
            ]
        },
        {
            "type": "file",
            "source": "./config",
            "destination": "/tmp"
        },
        {
            "type": "file",
            "source": "./scripts",
            "destination": "/tmp"
        },
        {
            "type": "shell",
            "inline": [
                "sudo /tmp/scripts/setup-influxdb-meta.sh {{ user `influxdb_version` }}",
                "sudo /tmp/scripts/setup-telegraf.sh {{ user `telegraf_version` }} data",
                "sudo rm -r /tmp/scripts /tmp/config",
                "rm .ssh/authorized_keys ; sudo rm /root/.ssh/authorized_keys"
            ]
        }
    ]
}
